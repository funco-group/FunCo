## 메시지 큐

**메시지 큐 & 메시지란?**

- 메시지
    - 애플리케이션에서 다른 애플리케이션이 이용할 수 있도록 생성하는 데이터 패킷
- 메시지 큐
    - 독립적인 애플리케이션과 서비스에서 정보를 교환할 수 있도록 지원
- 활용도가 매우 높은 기술

**좋은 웹 어플리케이션이 가져야 할 것들**

- 성능
- 안정(신뢰)성
- 보안

## 언제 필요한가?

- 미션 : 무인 주차 정산 시스템 구현
    - 입차 시 카메라로 차량번호 인식
    - *요금 할인 대상 차량 여부 확인(REST API)*
        - 해당 부분을 구현해야 하는 미션
    - 출차 시 주차 요금 자동 정산
- 미션 구체화
    - 경차, 저공해 차량 여부 체크
    - 장애우, 유공자 여부 체크
- 해결 1 : 4개 항목에 대해 REST API 요청 보내서 여부를 다 불러온다.
- 문제점 1 : 순차적으로 여부 체크 로직을 처리하면(Blocking) 지연됨
    - 관련 개념 : 동기/비동기, Blocking/Non-Blocking
- 해결 2 : 업무 이해에 기반한 적절한 비동기 처리
    - 사용 language, 프레임워크 환경에서 제공하는 것부터 고려
    - spring boot async
- 문제점 2 : 실사용 고려 시 WAS 재실행, 서버 이상 등 이슈가 발생하면 예상되는 문제는?
    - 한 대의 서버로는 이런 문제를 해결할 수 없음
- **해결 3 : 메시지 큐**
    - *메시지 버퍼* 역할을 하며 *비동기적*으로 전송
    - 서비스(서버)간 *느슨한 결합*이 가능
    - *메시지의 무손실*을 보장

## 메시지 큐

**메시지 큐를 사용할 이유**

- 기본 활용만으로도 많은 장점
- *단순 사용 경험보다는 어떠한 환경에서 어떤 이유로 적용했는지에 대한 가설을 세워본 경험이 중요*
- RabbitMQ 강력 추천

## RabbitMQ

- 다양한 클라이언트 라이브러리 제공
- 메시지 디스크 저장 설정 가능
- 메시지 무손실(영속성) 보장
- 고가용성을 위한 클러스터 설정 가능
- 접근성 좋은 Web UI 제공

## 정리

- 서비스를 분리하고 관계를 맺으려 한다면
- 적합한 사용 시나리오를 찾기 위해 노력해보자
- 비동기 처리를 통한 성능 향상과 서비스(서버)간 느슨한 결합이 가져다주는 장점을 경험해보자
- MSA를 고려하고 있다면 적극적/긍정적으로 고려해보자

## 메시지 큐 도입 시 고려할 사항 3가지

- 비동기
- 느슨한 설계
- 무손실

## 메시지 큐 트렌드

- RabbitMQ & Kafka 양강 구조
- RabbitMQ
    - 등기 서비스
- Kafka
    - 우편 서비스
- 적용되는 시점과 방법이 전혀 다른데 둘 중 하나를 고려해보면 되겠다.
- 거래에는 카프카를 쓰려고 했음
    - 영속 저장이 된다
    - 카프카가 중앙 저장소인데 소비자가 직접 꺼내가는 구조
    - 성능이 좋다, 그리고 서버가 죽는 상황
    - 카프카는 메시지 브로커가 아닌 이벤트 브로커이다.
    - 카프카는 소비자가 여럿이어도 순서가 보장된다.
- 채팅에는 RabbitMQ가 적합함
    - 채팅을 하는 방식에 kafka가 적합하지 않다.
    - 수많은 메시지를 영속 저장할 이유가 없음
    - RabbitMQ는 소비자가 하나여야만 순서가 보장
- ELK에 RabbitMQ
    - 채팅 서버에 RabbitMQ 있는데 굳이 또 추가할 필요가 없음

## **참고자료**

- 240424 자율 프로젝트 SSAFY 강의 “서비스 성능 및 안정성 향상을 위한 Message Queue 도입”
- 컨설턴트 님 강의
